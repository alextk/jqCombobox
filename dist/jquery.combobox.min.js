/*
* jqCombobox - jQuery plugin for creating styled select box (combobox)
*
* Version: 0.0.1
* Build: 4
* Copyright 2011 Alex Tkachev
*
* Dual licensed under MIT or GPLv2 licenses
*   http://en.wikipedia.org/wiki/MIT_License
*   http://en.wikipedia.org/wiki/GNU_General_Public_License
*
* Date: 31/07/2011 13:36:15
*/

(function(a){var b=function(){this.initialize.apply(this,arguments)};a.extend(b.prototype,{initialize:function(b,c){this.options=c,this.selectionModel=new a.fn.combobox.classes.SingleSelectionModel,this.items=c.items.collect(function(b){var c=a.isUndefined(b.text)?b.value:b.text,d=a.isUndefined(b.value)?b.text:b.value;return{text:c,value:d}}),c.empty&&this.items.unshift(c.emptyItem),this.el=this._createUI(b,c),this._bindListeners(),this.renderItems();var d=-1;a.isUndefined(c.selectedValue)||(d=this.items.findIndex(function(a){return a.value==c.selectedValue})),d==-1&&(d=0),this.selectionModel.index(d)},selectedIndex:function(){return this.selectionModel.index()},selectedValue:function(){var a=this.selectedIndex();if(a>=0)return this.items[a].value},togglePopup:function(b){var c=a("div.popup",this.el);a.isBoolean(b)||(b=!c.is(":visible")),b?this.showPopup():this.hidePopup()},showPopup:function(){var b=a("div.popup",this.el);b.show(),b.position(this.options.position),b.width(this.el.width()),a(document).bind("mousedown",{combobox:this},this._onDocumntMouseDown)},hidePopup:function(){a(document).unbind("mousedown",this._onDocumntMouseDown),a("div.popup",this.el).hide()},renderItems:function(){var b=a("div.popup",this.el),c=a('<ul class="items"/>'),d=function(b){return a('<li class="item"/>').html(b.text)};this.items.each(function(a){c.append(d(a))},this),b.html(c)},_onDocumntMouseDown:function(b){var c=a(b.target);c.closest("div.combobox-container").length===0&&b.data.combobox.hidePopup()},_onItemClick:function(b){var c=a(b.target),d=c.closest("li.item"),e=d.index();e!=-1&&(this.selectionModel.index(e),this.hidePopup())},_onSelectionChanged:function(b,c){a(".popup li.item",this.el).removeClass("selected");var d=this.selectionModel.index();if(d>=0){var e=this.items[d];a(".value",this.el).html(e.text),a("input[type=hidden]",this.el).val(e.value),a(".popup li.item",this.el).eq(d).addClass("selected"),this._invokeCallback("change",{source:this,oldIndex:c.oldIndex,newIndex:c.newIndex})}},_createUI:function(b,c){var d=a('<div class="combobox-container"><div class="value"/><input type="hidden"/><div class="popup" style="display: none"/></div>');d.toggleClass("rtl",c.rtl),b.replaceWith(d);var e=a(".value",d);e.height(d.height()).css({"line-height":d.height()+"px"}),c.position.of=e;return d},_bindListeners:function(){a(".value",this.el).click(this.togglePopup.bind(this)),a(".popup",this.el).click(this._onItemClick.bind(this)),this.selectionModel.on("change",this._onSelectionChanged,this)},_invokeCallback:function(b){var c=this.options.events[b];a.isFunction(c)&&c.apply(this.options.events.context||this,Array.prototype.slice.call(arguments,1))}}),a.fn.combobox=function(c){return c=="api"?this.data("api"):this.each(function(){var d=a(this);a.type(c)==="object"&&d.data("api",new b(d,a.extend(!0,{},a.fn.combobox.defaults,c,{rtl:d.css("direction")=="rtl"})))})},a.fn.combobox.classes={},a.fn.combobox.defaults={items:[],empty:!0,emptyItem:{text:"Please select value",value:""},position:{my:"left top",at:"left bottom"},events:{}}})(jQuery)