/*
* jqCombobox - jQuery plugin for creating styled select box (combobox)
*
* Version: 0.0.1
* Build: 17
* Copyright 2011 Alex Tkachev
*
* Dual licensed under MIT or GPLv2 licenses
*   http://en.wikipedia.org/wiki/MIT_License
*   http://en.wikipedia.org/wiki/GNU_General_Public_License
*
* Date: 28/09/2011 11:20:50
*/

(function(a){a.fn.combobox=function(b){if(b=="api")return this.data("api");if(b=="destroy")this.data("api").destroy(),this.removeData("api");else return this.each(function(){var c=a(this);if(a.type(b)==="object"){var d=b.type||a.fn.combobox.defaults.type,e=null;if(d=="single")e=a.fn.combobox.classes.Combobox;else if(d=="multi")e=a.fn.combobox.classes.MultipleCombobox;else throw"Unknown combobox type "+d;c.data("api",new e(c,a.extend(!0,{},a.fn.combobox.defaults,e.defaults||{},b,{rtl:c.css("direction")=="rtl"})))}})},a.fn.combobox.classes={},a.fn.combobox.defaults={type:"single",items:[],position:{my:"left top",at:"left bottom",offset:"-1 0"},events:{}}})(jQuery),function(a){var b=function(){this.initialize.apply(this,arguments)};a.extend(b.prototype,{initialize:function(b,c){this.target=b,this.options=c,this.selectionModel=new a.fn.combobox.classes.SingleSelectionModel,this.items=c.items.collect(function(b){var c=a.isUndefined(b.text)?b.value:b.text,d=a.isUndefined(b.value)?b.text:b.value;return{text:c,value:d}}),c.empty&&this.items.unshift(c.emptyItem),this.el=this._createUI(b,c),this._bindListeners(),this.renderItems();var d=-1;a.isUndefined(c.selectedValue)||(d=this.items.findIndex(function(a){return a.value==c.selectedValue})),d==-1&&(d=0),this.selectionModel.index(d)},selectedIndex:function(a){if(arguments.length==0)return this.selectionModel.index();this.selectionModel.index(a);return this},selectedValue:function(){var a=this.selectedIndex();if(a>=0)return this.items[a].value},togglePopup:function(b){var c=a("div.popup",this.el);a.isBoolean(b)||(b=!c.is(":visible")),b?this.showPopup():this.hidePopup()},showPopup:function(){var b=a("div.popup",this.el);b.show(),b.position(this.options.position),b.width(this.el.width()),a(document).bind("mousedown",{combobox:this},this._onDocumntMouseDown),this._invokeCallback("show",{source:this})},hidePopup:function(){a(document).unbind("mousedown",this._onDocumntMouseDown),a("div.popup",this.el).hide(),this._invokeCallback("hide",{source:this})},renderItems:function(){var b=a("div.popup",this.el),c=a('<ul class="items"/>'),d=function(b){return a('<li class="item"/>').html(b.text)};this.items.each(function(a){c.append(d(a))},this),b.html(c)},destroy:function(){this.el.remove()},_onDocumntMouseDown:function(b){var c=a(b.target);c.closest("div.combobox-container").length===0&&b.data.combobox.hidePopup()},_onItemClick:function(b){var c=a(b.target),d=c.closest("li.item"),e=d.index();e!=-1&&(this.selectionModel.index(e),this.hidePopup())},_onSelectionChanged:function(b,c){a(".popup li.item",this.el).removeClass("selected"),a("input[type=hidden]",this.el).val(""),a(".value",this.el).html("&nbsp;");var d=this.selectionModel.index();if(d>=0){var e=this.items[d];a(".value",this.el).html(e.text),a("input[type=hidden]",this.el).val(e.value),a(".popup li.item",this.el).eq(d).addClass("selected")}this._invokeCallback("change",{source:this,oldIndex:c.oldIndex,newIndex:c.newIndex})},_createUI:function(b,c){var d=a('<div class="combobox-container"><div class="value"/><input type="hidden"/><div class="popup" style="display: none"/></div>');d.addClass(c.type).toggleClass("rtl",c.rtl),b.html(d);var e=a(".value",d);e.height(d.height()).css({"line-height":d.height()+"px"}),c.position.of=e;return d},_bindListeners:function(){a(".value",this.el).click(this.togglePopup.bind(this)),a(".popup",this.el).click(this._onItemClick.bind(this)),this.selectionModel.on("change",this._onSelectionChanged,this)},_invokeCallback:function(b){var c=this.options.events[b];a.isFunction(c)&&c.apply(this.options.events.context||this,Array.prototype.slice.call(arguments,1)),a.isFunction(this.options.events.callback)&&this.options.events.callback.apply(this.options.events.context||this,Array.prototype.slice.call(arguments,1))}}),b.defaults={empty:!0,emptyItem:{text:"Please select value",value:null}},a.fn.combobox.classes.Combobox=b}(jQuery),function(a){var b=function(){this.initialize.apply(this,arguments)};a.extend(b.prototype,a.ext.mixins.Observable,{_index:-1,initialize:function(){},index:function(a){if(arguments.length<1)return this._index;if(this._index!=a){var b=this._index;this._index=a,this.fire("change",{oldIndex:b,newIndex:a})}},clear:function(){this.index(-1)}}),a.fn.combobox.classes.SingleSelectionModel=b}(jQuery),function(a){var b=function(){this.initialize.apply(this,arguments)};a.extend(b.prototype,{initialize:function(b,c){this.target=b,this.options=c,this.selectionModel=new a.fn.combobox.classes.MultipleSelectionModel,this.items=c.items.collect(function(b){var c=a.isUndefined(b.text)?b.value:b.text,d=a.isUndefined(b.value)?b.text:b.value;return{text:c,value:d}}),this.el=this._createUI(b,c),this._bindListeners(),this.renderItems();var d=[];a.isUndefined(c.selectedValues)||(d=this.items.select(function(a){return c.selectedValues.include(a.value)}).collect(function(a,b){return b})),this.selectionModel.indices(d)},selectedIndices:function(a){if(arguments.length==0)return this.selectionModel.indices();this.selectionModel.indices(a)},selectedValues:function(){var a=this.selectedIndices();return a.collect(function(a){return this.items[a].value},this)},togglePopup:function(b){var c=a("div.popup",this.el);a.isBoolean(b)||(b=!c.is(":visible")),b?this.showPopup():this.hidePopup()},showPopup:function(){var b=a("div.popup",this.el);b.show(),b.position(this.options.position),b.width(this.el.width()),a(document).bind("mousedown",{combobox:this},this._onDocumntMouseDown)},hidePopup:function(){a(document).unbind("mousedown",this._onDocumntMouseDown),a("div.popup",this.el).hide()},renderItems:function(){var b=a("div.popup",this.el),c=a('<ul class="items"/>'),d=function(b){return a('<li class="item"/>').append('<div class="icon"></span>',a('<div class="text">').html(b.text))};this.items.each(function(a){c.append(d(a))},this),b.html(c)},destroy:function(){this.el.remove()},_onDocumntMouseDown:function(b){var c=a(b.target);c.closest("div.combobox-container").length===0&&b.data.combobox.hidePopup()},_onItemClick:function(b){var c=a(b.target),d=c.closest("li.item"),e=d.index();e!=-1&&this.selectionModel.toggleIndex(e)},_onSelectionChanged:function(b,c){a(".popup li.item",this.el).removeClass("selected");var d=this.selectionModel.indices();d.each(function(b){var c=this.items[b];a(".popup li.item",this.el).eq(b).addClass("selected")},this);var e=d.collect(function(a){return this.items[a]},this);a(".value",this.el).html(e.length==0?this.options.emptyText:e.property("text").join(", ")),a("input[type=hidden]",this.el).val(e.property("value").join(", ")),this._invokeCallback("change",{source:this})},_createUI:function(b,c){var d=a('<div class="combobox-container"><div class="value"/><input type="hidden"/><div class="popup" style="display: none"/></div>');d.addClass(c.type).toggleClass("rtl",c.rtl),b.html(d);var e=a(".value",d);e.height(d.height()).css({"line-height":d.height()+"px"}),c.position.of=e;return d},_bindListeners:function(){a(".value",this.el).click(this.togglePopup.bind(this)),a(".popup",this.el).click(this._onItemClick.bind(this)),this.selectionModel.on("change",this._onSelectionChanged,this)},_invokeCallback:function(b){var c=this.options.events[b];a.isFunction(c)&&c.apply(this.options.events.context||this,Array.prototype.slice.call(arguments,1))}}),b.defaults={emptyText:"Please select values"},a.fn.combobox.classes.MultipleCombobox=b}(jQuery),function(a){var b=function(){this.initialize.apply(this,arguments)};a.extend(b.prototype,a.ext.mixins.Observable,{_indices:null,initialize:function(){this._indices=[]},indices:function(a){if(arguments.length<1)return this._indices;var b=this._indices;this._indices.clear(),Array.prototype.push.apply(this._indices,a),this.fire("change")},toggleIndex:function(a){this._indices.include(a)?this._indices.remove(a):this._indices.push(a),this.fire("change")},clear:function(){this.index([])}}),a.fn.combobox.classes.MultipleSelectionModel=b}(jQuery)